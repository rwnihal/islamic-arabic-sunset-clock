<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Arabic Sunset Clock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.1.2/moment-hijri.min.js"></script>

  <style>
    :root { --primary: #1a73e8; --text: #202124; --gray: #70757a; --border: #dadce0; }
    body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background: #fff; color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
    .container { max-width: 600px; width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    .header { text-align: left; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; }
    .next-prayer { color: var(--gray); font-size: 14px; margin-bottom: 5px; }
    .ghurubi-time { font-size: 56px; font-weight: 400; margin: 10px 0; }
    .hijri-date { color: var(--gray); font-size: 14px; }

    .prayer-table { width: 100%; display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; text-align: center; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
    .prayer-item { padding: 10px 0; }
    .p-name { font-size: 13px; font-weight: 700; color: var(--gray); margin-bottom: 8px; }
    .p-time { font-size: 13px; margin-bottom: 4px; }
    .p-ghurubi { font-size: 12px; color: var(--primary); font-weight: 600; }

    .daily-verse { margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary); }
    .verse-ar { font-size: 20px; direction: rtl; display: block; margin-bottom: 8px; }
    .verse-en { font-size: 14px; color: #444; font-style: italic; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div id="countdown" class="next-prayer">Requesting location...</div>
    <div id="ghurubi-clock" class="ghurubi-time">--:--</div>
    <div id="hijri-display" class="hijri-date">-- --- ----</div>
  </div>

  <div id="prayer-grid" class="prayer-table"></div>

  <div class="daily-verse">
    <span id="q-ar" class="verse-ar"></span>
    <p id="q-en" class="verse-en"></p>
  </div>
</div>

<script>
  const toAr = (n) => Number(n).toLocaleString('ar-SA');
  
  // Authentic content rotation
  const verses = [
    { ar: "وَقُل رَّبِّ زِدْنِي عِلْمًا", en: "And say: My Lord, increase me in knowledge. (20:114)" },
    { ar: "فَاذْكُرُونِي أَذْكُرْكُمْ", en: "So remember Me; I will remember you. (2:152)" }
  ];

  async function init() {
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        updateUI(pos.coords.latitude, pos.coords.longitude);
        setInterval(() => updateUI(pos.coords.latitude, pos.coords.longitude), 30000);
      },
      () => { document.getElementById('countdown').textContent = "Please enable location access."; }
    );
  }

  async function updateUI(lat, lon) {
    const now = new Date();
    const sun = SunCalc.getTimes(now, lat, lon);
    
    // 1. Current Ghurubi Clock
    let ref = now >= sun.sunset ? sun.sunset : SunCalc.getTimes(new Date(now - 86400000), lat, lon).sunset;
    const diff = now - ref;
    const h = Math.floor(diff/3600000) % 24;
    const m = Math.floor((diff/60000)%60);
    document.getElementById("ghurubi-clock").textContent = `${toAr(h)}:${toAr(m.toString().padStart(2, '0'))}`;

    // 2. Hijri Date
    let hijri = moment();
    if (now >= sun.sunset) hijri.add(1, 'days');
    document.getElementById("hijri-display").textContent = hijri.format('iDD iMMMM iYYYY');

    // 3. Prayer Times (Umm al-Qura Method)
    const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=4`);
    const data = await res.json();
    const p = data.data.timings;
    const names = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

    // Countdown Logic
    let nextName = "", nextDiff = "";
    for (let name of names) {
      const [ph, pm] = p[name].split(':');
      const pDate = new Date(); pDate.setHours(ph, pm, 0);
      if (pDate > now) {
        nextName = name;
        const dMin = Math.round((pDate - now) / 60000);
        nextDiff = dMin > 60 ? `${Math.floor(dMin/60)}h ${dMin%60}m` : `${dMin}m`;
        break;
      }
    }
    document.getElementById("countdown").textContent = `Next prayer: ${nextName} in ${nextDiff}`;

    // 4. Prayer Table with dual times
    document.getElementById("prayer-grid").innerHTML = names.map(name => {
      const [ph, pm] = p[name].split(':');
      const pDate = new Date(); pDate.setHours(ph, pm, 0);
      let pRef = pDate >= sun.sunset ? sun.sunset : SunCalc.getTimes(new Date(pDate - 86400000), lat, lon).sunset;
      const pDiff = pDate - pRef;
      const phAr = Math.floor(pDiff/3600000) % 24;
      const pmAr = Math.floor((pDiff/60000)%60);

      return `
        <div class="prayer-item">
          <div class="p-name">${name}</div>
          <div class="p-time">${p[name]}</div>
          <div class="p-ghurubi">${toAr(phAr)}:${toAr(pmAr.toString().padStart(2, '0'))}</div>
        </div>`;
    }).join('');

    // 5. Daily Verse
    const day = Math.floor(now / 86400000) % verses.length;
    document.getElementById("q-ar").textContent = verses[day].ar;
    document.getElementById("q-en").textContent = verses[day].en;
  }

  init();
</script>
</body>
</html>
